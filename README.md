# BlockChainTree
区块链技术

<pre>
区块链起源
    区块链的英文是BlockChain，字面意思就是交易数据块的链。区块链技术首先被应用于比特币。
    
    定义：
        关于区块链没有统一的定义，综合来看，区块链就是基于区块链技术形成的公共数据库。其中区块链技术是指多个参与方之间基于现代密码学，分布式一
    致性，点对点网络通信技术和智能合约编程语言形成的数据交换。

    分类：
        以参与方分类
            1）公开链
               对外公开，用户不用注册就能匿名参与，无需授权即可访问网络和区块链，节点可选择自由出入网络。公开链上的区块可以被任何人查看，任何人也
可以在公开连上发送交易，还可以随时参与网络上形成共识的过程。即决定哪个区块可以加入区块链并记录当前的网络状态。公开连是真正意义上的完全去中心化的区
块链。它通过密码学保证交易不可篡改，同时也利用密码学验证以及经济上的激励，在互为陌生的网络环境中建立共识，从而形成去中心化的信用机制，在公共链中的
共识机制一般是工作量证明或权益证明，用户对共识形成的影响力直接取决于他们再网络中拥有资源的占比。

               如比特币和以太坊等都是公共链，公共链一般适合于虚拟货币，面向大众的电子商务，互联网金融等B2C, C2C, C2B等应用场景

            2）联盟链
            3）私有链
</pre>

<pre>
P2P网络协议
   目前，大部分的区块链项目所使用的底层网络传输协议是TCP/IP协议，少部分支
   持UDP协议，从协议层角度看，区块链是基于TCP/IP协议的，也就是在传输层
   之上，属于最上面的应用层。

   因此，“区块链颠覆互联网”这种说法是不值一驳的，它本身就属于互联网大框架中的一部分，也只能是属于同一层的其他网络协议，比如HTTP协议等。

   P2P网络本身的拓步结构有很多种，比如树形，星型，网状型。比特币全节点组成的网络是一种全分布式的拓步结构，类似于网状型。节点与节点之间的传输过
   程采用的是广播方式：交易从某个节点产生，然后该节点将交易广播给邻近节点，交易被邻近节点验证通过后，临近节点啊再广播给他们自己的临近节点，如此
   层层传开，直至全网节点都能收到。

   全节点与简化支付验证客户端之间的交互模式则不一样，SPV节点可以随机选择一个全节点进行连接，这个全节点就成为SPV节点的代理，帮助SPV节点进行交易广播。

   节点发现
       节点发现可分为初始节点发现和启动节点发现两种。
           1）初始节点发现是指某个节点是新建立的，第一次运行，上面没有任何关于其他节点的数据和信。
           2）启动后发现是指某个全节点已经处于运行状态，在运行状态过程中发
           现其他新节点。

       初始节点发现的第一种方式是DNS-seed，又称DNS种子节点。DNS即域名查询，在比特币社区里会维护一些域名，比如 seed.bitcoin.sipa.be这个
       域名就是由比特币核心开发者Sipa维护的，通过查询这些域名，我们能够知道目前已经有哪些节点，他们的IP地址是多少，这样就可以通过命令来与这些节
点建立连接。

       初始节点发现的第二种方式是通过代码中的硬编码来查找节点，在比特币代码中已经硬编码了一些地址，这些地址被称为种子节点，种子节点是一些长期稳定
运行的节点，连接到种子节点的好处是可以通过种子节点来快速发现网络中的其他节点。

       启动后节点发现是节点在运行后对对等节点进行动态维护的过程，在比特币网络中，一个节点可以将自己维护的对等节点列表发给临近节点，节点在运行过程
中必须持续进行两项操作：
           在失去已有连接时发现新节点，并在其他节点启动时为其提供帮助。

       在启动完成后，节点会记住它最近成功连接的对等节点，这样，当重新启动后，它可以迅速与先前的对等节点网络重新建立连接，如果先前的网络的对
等节点对连接请求无应答，该节点可以使用种子节点重启，如果节点持续某个连接长达90分钟没有任何通信，它会被认为已经从网络中断开，网络将开始
查找一个新的对等节点。

局域网穿透：
   如果想在一个局域网里部署区块链节点，就需要用到局域网穿透技术了。
   因为比特币的P2P网络是全分布式的，建立在互联网上的，所以如果你在局域网里运行一个节点，公网是发现不了的，如果想打破这个局面，就必须在局域网与公网
之间建立一个通道，通过这个通道来进行信息的交互，这就是IP地址的映射，通过NAT技术，UPnp协议，我们可以自动完成这个通道建立的过程。
 
   NAT技术又叫网络地址转换技术，是一种在IP数据包通过路由器或防火墙时重新来源IP地址或目标IP地址的技术，当来自局域网内的IP地址想与公网地址通信时，
需要借助NAT主机作为中介，由NAT主机将局域网内的IP地址转换为公网IP地址，与外部通信。

   UPnP是通用即插即用的缩写，它主要用于设备的智能互联互通，通过UPnp，所有在网络上的设备马上就能知道有新设备加入，在比特别与以太坊中均使用了这种协议
作为局域网穿透的工具，只要局域网中的路由设备支持NAT和UPnp功能，就可以将局域网中的区块链节点自动映射到公网上。

节点交互协议
   节点在建立连接后，会不断地进行信息交互，交互的主要内容就是一些特定的命令以及相关的信息，其中，命令写在消息的头部，信息写在消息体中。

   命令分为请求命令和数据交互命令。
   节点连接完成后做的第一件事就是进行握手，互相了解对方信息，比如看双方的版本号是否相同或者兼容等。

   在握手完毕后，无论交互什么信息，都需要保持长连接，在比特币网络中，节点之间需要通过PING/PONG两种类型的消息来保持连接，一旦超过90分钟未收到对方
的消息，则认为对方已经从网络中断开，会开始发现新的节点。

   请求命令用于发起者向对方发送一个请求，比如请求对方发送节点列表等，数据交互命令则用于数据的传输， 比如节点信息同步等。

   节点信息的同步有两种方式，一种是区块头优先即先将历史区块的消息头等信息先同步完，然后再从其他节点同步消息体。
       另一种是区块优先，即直接从其他节点同步完成的消息。
       这两种方式对网络的影响不同，前一种能够较好的减轻网络负担。   

P2P技术优点：
   非中心分散化：将以服务器为中心的服务分散到各个网络节点，避免出现服务器性能瓶颈。
   扩展性：随着更多用户的加入，网络整体资源和服务得到了扩充和提升。
   健壮稳定性：网络自组织管理，网络中某一节点或局部网络出现问题对整个网络不会有很大的影响。
   资源共享：能有效的利用网络中闲置的硬件资源进行计算，存储。
   优化传播速度：数据传播是直接在节点之间传送的，因此当用户数据增加时，其
   数据传播速度回大大加强。

P2P技术缺点：
   因为广域网用户直接通讯传输没有确保安全，所以传输的文件数据会有危害性或失真，版权问题，管理困难，垃圾信息，吞噬网络带宽，慈善病毒，标准之争
   除了上述的缺点外，P2P网络还是一种比较脆弱的网络：
        在P2P网络中，服务不再是网络的中心，但是任然协调着整个网络的工作，服务器的瘫痪将导致整个网络的瘫痪，不难想象，一个拥有众多用户的P2P网络将
   会成为黑客的攻击目标，这将极大的威胁P2P网络的安全。

P2P的应用
   对等计算
       采用P2P技术的对等计算，正式网络中的众多计算机暂时不用的计算能力连接起来，使用积累的能力执行超级计算机的任务，任何需要大量数据处理的行业
   都可以从对等计算中获利，有了对等计算之后，就不再需要昂贵的计算机了，从本质而言，对等计算就是网络上CPU资源的共享。

   协同工作：
      P2P技术的出现，使得互联网上任意两台PC都可建立实时的联系，建立了这样一个安全共享的虚拟空间，人们可以进行各种各样的活动，这些活动可以是
   同时进行，也可以交互进行,P2P技术可以帮助企业和关键客户，以及合作伙伴之间建立一种安全的网上工作联系模式。

   搜索引擎：
      P2P技术使用户能够深度搜索文档，而且这种搜索无需通过WEB服务器，也可以不受信息文档格式和宿主设备的限制，可达到传统目录是搜索引擎无可比拟的
      深度，可以说P2P为互联网的信息搜索提供了全新的解决之道。

   文件交换：
      可以说文件交换的需求直接引发了P2P技术热潮，在传统的WEB方式中，要实现文件交换需要服务器的大力参与，通过将文件上传到某个特定的网站，用户
   再到某个网站搜索需要的文件，然后下载，这种方式的不便之处不言而喻。电子邮件是方便了个人间文件传递问题，却没法解决大范围的交换，这也是WEB的重
   要缺陷，而P2P技术能够完全克服这些问题

   企业应用：
      应用P2P技术的互联网产品正在迅速开辟出一块新的互联网应用市场，例如ICQ类的及时信息工具不经创立了一个巨大市场，而且正在多个方向地向外扩展，
   比如在移动通信市场，ICQ产品的多信息格式，可以为常规通信增加信息呢绒和通信对象。
</pre>

<pre>
区块链的共识机制
   区块链是一个公共账本，公开的数据库，同时也是一个点对点的协作网络。协作方（节点）共同维护数据，每个节点都有一份完整的数据备份，所有节点的数据
内容必须完全一致，每个节点都可以在本地查找交易记录，每个节点也可以在本地添加交易。

   没有一个中心来指挥，协调，要完成这个协作，区块链就必须有一个共识机制，
   这个机制必须解决两个基本问题：
       1：谁有权写入数据---一次只有一个可以记账，
       2：其他人如何同步数据---因为要保持账本的一致性
   数据写入（区块添加）的过程是这样的：有权打包交易的节点，将打包的交易（区块）放入既有的数据库（区块链）上，并向全网广播，其他节点收到信息，
   验证区块无误，就会同步这个新打包的交易。每个打包的交易叫做一个区块，区块不断叠加，延长区块链。

   同步数据有一个问题，就是如何对在一定时间内发生的交易的先后顺序达成一致？
   
   由于各个节点都在自发地记账或者同步，在点对点相互通信下的情况存在较高的网络延迟，因此各个节点收到数据的先后顺序是不一致的，你记你的，我记
   我的，如何保证每个节点副本数据的一致性？

   区块链的共识机制重点要解决第一个问题：谁有权写入数据？
   
   随着区块链的发展，已经有多重方法解决这个问题了，主要介绍三种 POW, POS DPOS

   POW(Proof of Work)工作量机制
   这里的工作量，指的是计算机计算Nonce(随机数)的过程。每个节点都去计算一个随机数，一定时间内，找到随机数的难度是一定的，这就意味着，得到这个随机
   数必然要经过一定的工作量，最先得到这个随机数的节点，将打包的交易区块添加到既有的区块链上，并向全网广播，其他节点验证，同步。

   POS(Proof of Stake)权益证明
   POW以计算随机数的工作量作为数据写入权的考量，而POS，则是系统根据节点持有的token（代币）的数量及时间的乘积，分配相应的记账权，拥有的越多，获
   得记账权的概率越大。Token就相当于区块链系统的权益(stake)，因此被称为基于权益的证明。

   DPOS权益授权证明
   POS是拥有Token就用拥有获得记账的权利，而DPOS是指拥有Token的人投票给固定节点，这些节点作为权益人的代理去行驶记账的权利。这些获得投票认可的代表
   根据一定的算法一次获得记账权，不同于POW和POS理论上全网都可以的参与记账竞争，DPOS的记账节点在一定时间段内是确定的。

   这些证明机制的底层是代码，加密算法，他们提供了“谁来记账”这个问题的档案，总的来讲，他们都要在效率和去中心化这两个维度上作出平衡。

   第一  如何吸引人参与协作？
       这和中心化组织是一样的，依靠激励。只是中心组织依靠中心发放的奖励，而区块链靠分配Token激励各方参与协作。

   第二 不守规则的人如何处理
       向参与协作就必须遵守设定的规则，不愿意接受共识，自然无法成为协作组织的一员
   
   第三  如果有人参与协作 却试图破坏共识怎么办？
       因为区块链的共识是每个节点都尝试延长主链，而主链的区块最多，大多数节点共同维护认可的数据库，所以少数节点的破坏不会有任何影响，就像一帮人走
   路，大部队走的路才是正路。

   那么，多数节点试图破坏呢？这就是所谓的51%攻击，理论上可能，但实践中几乎不可能，这一方面是因为代价太高，另一方面协作各方基于利益考量甚至会主动
规避这种可能性。

   于是，基于代码，加密算法，博弈形成的共识机制，提供了一种全新的协作方式各方按照既定规则参与协作，代码代替权威，Token产生激励，博弈驱逐破坏者，
协作自然达成。
</pre>

![](https://i.imgur.com/UlLPJ2y.png)

![](https://i.imgur.com/i1sEwLV.png)

![](https://i.imgur.com/kO5kQYZ.png)

<pre>
密码学
   哈希函数(Hash function)能够把任意长度的输入映射成固定长度的输出，即散列
   值。
  
   区块链中，哈希函数主要用于数据完整性，数据加密，共识计算的工作量证明，区块之间链接等。

   如果要求Hash算法达到密码学安全的话，我们还要求它具备以下三个附加特性：
       1）碰撞阻力
         是指对于两个不同的输入，必须产生两个不同的输出。如果对于两个不同的输入产生了相同的输出，那么就说明不具备碰撞阻力，或是弱碰撞阻力

       2）隐秘性
         也被称为不可逆性，是指y = Hash(x)，通过输入x，可以计算出输出值y,但是无法通过y值去反推计算出x值，为了保证不可逆，就得让x的取值来
       自一个非常广泛的集合，使之很难通过计算反推出x值。

       3）谜题友好
         这个特性可以理解为，谜题是公平友好的，例如算法中y = Hash(x)，如果已知y值，想去得到x值，那就必须暴力枚举，不断的尝试才能做到，并且没有比
       这更好的办法，没有捷径。

Hash算法有很多，比特币主要使用的Hash算法是 SHA-256算法
    在比特币中，使用Hash算法把交易生成数据摘要，当前区块里面包含上一个区块的哈希值，后面一个区块又包含当前区块的哈希值，就这样一个接一个的连接起
来，形成一个哈希指针链表。

Prev Block：记录前一个区块的hash地址，32字节
Merkle Root：是一个记录当前块内的所有交易信息的数据摘要hash值，32字节
Nonce：一个随机值，需要通过这个随机值去找到满足某个条件的hash值（挖矿）,4字节

这所有的字段一起就组成了block header（区块头）,然后需要对block header进行2次hash计算，计算完成的值就是当前比特币区块的hash值，因为比特币系统要求
计算出来的这个hash值满足一定的条件，因此需要我们不断的遍历Nonce值去计算新的hash值，只有找到满足要求的hash值，那么这就是一个合法区块了（这一系列动
作叫做挖矿）

比特币中对每一笔交易做一个hash计算，然后把每2个交易的hash再进行合并做hash，如图中的交易A的Hash值H(A),交易B的哈希值H(B)，再对这2个交易合并hash后
就是H(ha|hb)，就这样一直往上合并计算，算到最后的根部就是Merkle Root了。

在比特币和以太坊中都是使用的默克尔树结构，但是以太坊为了实现更多复杂的功能，所以有3个默克尔树。
</pre>

<pre>
账户与存储
    区块链中有一个很关键的点就是账户问题，但比特币中是没有账户概念的，那大家是怎么进行转账交易的呢？

    这里就得先介绍区块链中的非对称加密技术了。

    非对称加密技术又很多种，如: RSA, ECC, ECDSA等，比特币中是使用的ECDSA算法。

    ECDSA是美国政府的标准，是利用了椭圆曲线的升级版，这个算法经过了数年的细致密码分析，被广泛认为是安全可靠的。

    所谓非对称加密是指我们在对数据进行加密和解密的时候，需使用两个不同的秘钥。比如，我们可以用A秘钥将数据进行加密，然后用B秘钥来解密，相反，也可以
用B来加密，然后使用A来解密，那么如果我想给某个人传递信息，那我可以先用A加密后，将密文传给她，她拿到密文后，用手上的B秘钥去解开，这2个秘钥，一个呗称
为公钥，一个是私钥。

    在比特币中，每个用户都有一对秘钥（公钥和私钥），比特币系统中是使用用户的公钥作为交易账户的。

    从上图中可以看到，在第一笔交易记录中，是用户U0来发起的交易，要将代币支付给用户U1,是怎么实现的呢？

    首先，用户U0写好交易信息：data(明文，例如：用户U0转账100元给用户U1)
       用户U0使用哈希算法将交易信息进行计算，得出H = hash(data)，然后再使用自己的私钥对H进行签名，即S(H),这一步其实是为了防止教习信息被篡改。
 
     然后基于区块链网络，将签名S(H)和交易信息data传递给用户U1

     用户U1使用用户U0的公钥对S(H) 解密，就得到了交易信息的哈希值 H,

     同时，用户U1 还使用哈希算法对 交易信息data 进行计算，得出 H2 = hash（data）

     对比上面2个哈希值，如果 H1 == H2,则交易合法，说明用户U0在发起交易的时候确实拥有真实的私钥，有权发起自己账户的交易。

     网络中每个节点都可以参与上述的验证步骤。
</pre>
